---
title: "Winter_DH_Germination_barley_analysis"
author: "Karl Kunze"
date: "10/26/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---
Workflow:
Winter_DH_data_consolidation.Rmd ->analysis_script.R->WDH_GenotypeData_Processing.Rmd

reading in files
```{r}
path<-"C:/Users/Karl/git/BarleyGermination-KK"
setwd(path)
getwd()

library(readxl)

TP1_half<-as.data.frame(read.csv("data/Winter_DH/TP1/DHtp1_full_F.csv",stringsAsFactors = FALSE))

TP2<-as.data.frame(read.csv("data/Winter_DH/TP2/DHtp2_all_F.csv",stringsAsFactors = FALSE))

TP3<-as.data.frame(read.csv("data/Winter_DH/TP3/DHtp3_all_F.csv",stringsAsFactors = FALSE))
TP4<-as.data.frame(read.csv("data/Winter_DH/TP4/DHtp4_all_combined_F.csv",stringsAsFactors = FALSE))

table(TP2$Entry)
str(TP1_half)

str(TP2)
str(TP3)
str(TP4)

###
library(tibble)
library(dplyr)




###
TP3KK<-TP3[TP3$replication=="2",][,c(2,8:13)]
TP3TR<-TP3[TP3$replication=="1",][,c(2,8:13)]
TP4KK<-TP4[TP4$replication=="2",][,c(2,8:13)]
TP4TR<-TP4[TP4$replication=="1",][,c(2,8:13)]
str(TP3KK)
str(TP3TR)
cor(TP3TR$Day1Germ,TP3KK$Day1Germ,use = "complete.obs")
cor(TP3TR$Day2Germ,TP3KK$Day2Germ,use = "complete.obs")
cor(TP3TR$Day3Germ,TP3KK$Day3Germ,use = "complete.obs")
cor(TP3TR$Day4Germ,TP3KK$Day4Germ,use = "complete.obs")
cor(TP3TR$Day5Germ,TP3KK$Day5Germ,use = "complete.obs")

TP3KKmean <- colMeans(TP3KK[,2:7], na.rm=TRUE)
TP3TRmean <- colMeans(TP3TR[,2:7],na.rm=TRUE)

TP4KKmean <- colMeans(TP4KK[,2:7], na.rm=TRUE)
TP4TRmean <- colMeans(TP4TR[,2:7],na.rm=TRUE)

cor(TP4TR$Day1Germ,TP4KK$Day1Germ,use = "complete.obs")
cor(TP4TR$Day2Germ,TP4KK$Day2Germ,use = "complete.obs")
cor(TP4TR$Day3Germ,TP4KK$Day3Germ,use = "complete.obs")
cor(TP4TR$Day4Germ,TP4KK$Day4Germ,use = "complete.obs")
cor(TP4TR$Day5Germ,TP4KK$Day5Germ,use = "complete.obs")

corday3<-merge(TP3[TP3$UserDay5=="KK",][,c(2,8:13)],TP3[TP3$UserDay5=="TR",][,c(2,8:13)],by="Entry")

cor(TP1[TP1$UserDay5=="KK",]$Day1Germ,TP2[TP1$UserDay5=="TR",]$Day1Germ,na.rm=TRUE)

TP_all<-rbind(TP1_half[,-1],TP2[,-1],TP3[,-1],TP4[,-1])

colnames(TP1_half)
colnames(TP2)
colnames(TP3)
colnames(TP4)
table(TP_all$Entry)
```
add field phenotype data
```{r}
DH_2020_Snyder<-as.data.frame(read_excel("data/Winter_DH/WMB_DH_2020_kkGit.xlsx",sheet = "Snyder"))
DH_2020_Ketola<-as.data.frame(read_excel("data/Winter_DH/WMB_DH_2020_kkGit.xlsx",sheet = "Ketola"))
DH_2020_PHS<-as.data.frame(read.csv("data/Winter_DH/WMB_DH_2020_Ketola_PHS.csv",stringsAsFactors = TRUE))

DH_2020_field<-rbind(DH_2020_Snyder,DH_2020_Ketola)

DH_2020_field<-merge(DH_2020_field,DH_2020_PHS,by=c("PLOT","Entry"),all = TRUE)

```
converting PHS scores
```{r}
str(DH_2020_field)
str(TP_all)
colnames(DH_2020_field)
#reduce 
# Phs conversion
five_avg=function(df,pheno,new_pheno,missing_phenos=F){
  df[[pheno]]=as.numeric(df[[pheno]])
  df <- cbind(df, "ID" = outer(df[[pheno]], 10^c(4:0), function(a, b) a %/% b %% 10))
  if(missing_phenos==T){
    df$ID.1[which(df$note=="*")]=NA
  }
  df$new_pheno=apply(df[,c((ncol(df)-4):ncol(df))],1,function(x) mean(x, na.rm=T))
  df$new_pheno=as.numeric(df$new_pheno)
  # df$var=as.numeric(apply(df[,c((ncol(df)-4):ncol(df))], 1,var))
  #df$sd=as.numeric(apply(df[,c((ncol(df)-5):(ncol(df)-1))], 1,function(x) sd(x, na.rm=T)))
  #df=df[,c(1:(ncol(df)-9),(ncol(df)-2),(ncol(df)-1), ncol(df))]

}



DH_2020_field$Sprout.Score
DH_2020_field$phs=five_avg(df=DH_2020_field,pheno='Sprout.Score',new_pheno='phs')
DH_2020_field$phs
  

```

#Dissecting GE, GI and GIScale for 5 day
```{r}
####taking apart functions that calculate GE, GI, GIScale to develop 5 day(5D) caluclatios
#TP_all0<-TP_all
#df<-TP_all0
#df$GE=apply(df[,8:13],1,function(x) {sum(as.numeric(x[1:3]))/sum(as.numeric(x[1:6]))})  #does not count dead kernels in total count

  #df$GC=apply(df[,6:10],1,function(x) {sum(as.numeric(x[1:4]))/sum(as.numeric(x[1:5]))}) #does count dead kernels

 # df$GI=apply(df[,8:13],1, function(x) {(sum(as.numeric(x[1:3]))/(as.numeric(x[1])+2*as.numeric(x[2])+ 3*as.numeric(x[3])))*10})


#df$GIscale=apply(df[,c(27,28)],1, function(x) {as.numeric(x[1])*as.numeric(x[2])}) #GI*GE
#df$GIscale
 # df$GE_5D=apply(df[,8:13],1,function(x) {sum(as.numeric(x[1:5]))/sum(as.numeric(x[1:6]))})

## Need to add 5 day extension to denominator of GI below

  #df$GI_5D=apply(df[,8:13],1, function(x) {(sum(as.numeric(x[1:5]))/(as.numeric(x[1])+2*as.numeric(x[2])+ 3*as.numeric(x[3])+4*as.numeric(x[4])+5*as.numeric(x[5])))*10})
 
  #df$GIscale_5D=apply(df[,c(29,30)],1, function(x) {as.numeric(x[1])*as.numeric(x[2])}) #GI*GE
  
  


```


```{r}
colnames(TP_all)
Germ_traits=function(df){
  df$GE=apply(df[,8:13],1,function(x) {sum(as.numeric(x[1:3]))/sum(as.numeric(x[1:6]))})  #does not count dead kernels in total count
  #df$GC=apply(df[,6:10],1,function(x) {sum(as.numeric(x[1:4]))/sum(as.numeric(x[1:5]))}) #does count dead kernels
  df$GI=apply(df[,8:13],1, function(x) {(sum(as.numeric(x[1:3]))/(as.numeric(x[1])+2*as.numeric(x[2])+ 3*as.numeric(x[3])))*10})
  df$GIscale=apply(df[,c(27,28)],1, function(x) {as.numeric(x[1])*as.numeric(x[2])}) #GI*GE
 #5 day 
  df$GE_5D=apply(df[,8:13],1,function(x) {sum(as.numeric(x[1:5]))/sum(as.numeric(x[1:6]))})
  df$GI_5D=apply(df[,8:13],1, function(x) {(sum(as.numeric(x[1:5]))/(as.numeric(x[1])+2*as.numeric(x[2])+ 3*as.numeric(x[3])+4*as.numeric(x[4])  + 5*as.numeric(x[5]) ))*10})
  df$GIscale_5D=apply(df[,c(29,30)],1, function(x) {as.numeric(x[1])*as.numeric(x[2])}) #GI*GE
  
  df$Plus_PM=as.factor(df$PM_at_plating)
 
  df$replication=as.factor(df$replication)
  df$Timepoint=as.factor(df$Timepoint)
  df
 } 













TPall$GI
table(TPall$Entry)
TPall=Germ_traits(TP_all)
colnames(TPall)

TPall$GIscale
TPall$GIscale_5D

colnames(DH_2020_field)
All_pheno_TPall<-merge(DH_2020_field,TPall,by=c("PLOT","Entry","Location"),all = TRUE)
str(All_pheno_TPall)
All_pheno_TPall$GIscale_5D
All_pheno_TPall$GIscale
#View(All_pheno_TPall)
save(All_pheno_TPall, file="WMB DH 2020 all data for analysis.RData")

```

