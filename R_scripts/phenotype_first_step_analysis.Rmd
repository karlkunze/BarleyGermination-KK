---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Old Workflow:Winter_DH_data_consolidation.Rmd ->analysis_script.R->WDH_GenotypeData_Processing.Rmd
# New workflow Winter_DH_data_consolidation.Rmd->phenotype_first_step_analysis.Rmd->GWAS_script.RMD


# read in packages
```{r}



load("data/WMB_DH_Germination_data2020_2021.RData")#DH2020_2021
load("data/WMB_DH_Germination_data2020_2021_wide_format.RData")#DH2020_2021_wide
table(DH2020_2021$taxa)
load("data/Genotype_data/wmb_file.Rdata")
```



#ANOVA analysis across year and GE, GI
```{R}
anova(lm(GI~ taxa +Location+replication, DH2020_2021%>% filter(DH2020_2021$Year=="2020",DH2020_2021$PM_date ==5)))
anova(lm(GI~ taxa +Location+replication, DH2020_2021%>% filter(DH2020_2021$Year=="2020",DH2020_2021$PM_date ==19)))
#Location significant
anova(lm(GI~ taxa +Location+replication, DH2020_2021%>% filter(DH2020_2021$Year=="2020",DH2020_2021$PM_date ==47)))
#Location significant
anova(lm(GI~ taxa +Location+replication, DH2020_2021%>% filter(DH2020_2021$Year=="2020",DH2020_2021$PM_date ==96)))
#replication significant
anova(lm(GI~ taxa +Location+replication, DH2020_2021%>% filter(DH2020_2021$Year=="2020",DH2020_2021$PM_date ==152)))
#all significant
#DH 2020 GE
anova(lm(GE~ taxa +Location+replication, DH2020_2021%>% filter(DH2020_2021$Year=="2020",DH2020_2021$PM_date ==5)))
#Location
anova(lm(GE~ taxa +Location+replication, DH2020_2021%>% filter(DH2020_2021$Year=="2020",DH2020_2021$PM_date ==19)))
#Location significant
anova(lm(GE~ taxa +Location+replication, DH2020_2021%>% filter(DH2020_2021$Year=="2020",DH2020_2021$PM_date ==47)))
#Location significant and rep
anova(lm(GE~ taxa +Location+replication, DH2020_2021%>% filter(DH2020_2021$Year=="2020",DH2020_2021$PM_date ==96)))
#location and rep significant
anova(lm(GE~ taxa +Location+replication, DH2020_2021%>% filter(DH2020_2021$Year=="2020",DH2020_2021$PM_date ==152)))
#field analysis 2020

anova(lm(GE~ taxa +Location+replication, DH2020_2021%>% filter(DH2020_2021$Year=="2020",DH2020_2021$PM_date ==152)))
#field analysis 2020
DH2020_2021$Maturity_date<-DH2020_2021$Maturity_date+76

anova(lm(GI~ taxa +Location+Maturity_date, DH2020_2021%>% filter(DH2020_2021$Year=="2020",DH2020_2021$PM_date ==5)))#Location significant

#Does it make sense that Maturity date is still significant even though we controlled for it?
anova(lm(GI~ taxa +Location+replication+Maturity_date, DH2020_2021%>% filter(DH2020_2021$Year=="2020",DH2020_2021$PM_date ==19)))

#Location significant, winter survival significant
anova(lm(GI~ taxa +Location+replication+Maturity_date, DH2020_2021%>% filter(DH2020_2021$Year=="2020",DH2020_2021$PM_date ==47)))

#Location significant and rep
anova(lm(GI~ taxa +Location+replication, DH2020_2021%>% filter(DH2020_2021$Year=="2020",DH2020_2021$PM_date ==96)))
#location and rep significant, scald significant for GE, not GI
anova(lm(GI~ taxa +Location+replication, DH2020_2021%>% filter(DH2020_2021$Year=="2020",DH2020_2021$PM_date ==152)))
anova(lm(Day1Germ~ taxa +Maturity_date:Location+replication, DH2020_2021%>% filter(DH2020_2021$Year=="2020",DH2020_2021$PM_date ==152)))


#Summation, we need to consider Maturity date in the model, it affects GE at all timepoints and GI for timepoints 1, 2 and 3
#scald affected GE for timepoint 4
#2021 GI
table(DH2020_2021$PM_date,DH2020_2021$Year)#add 12, 33, 68

#scald associated with GI at timepoint 3.5 or so
#scald associated with GE at timepoint 19,33, and 47
anova(lm(GE~ taxa , DH2020_2021%>% filter(DH2020_2021$Year=="2021",DH2020_2021$PM_date ==19)))
#Location
anova(lm(GI~ taxa +Location+replication, DH2020_2021%>% filter(DH2020_2021$Year=="2021",DH2020_2021$PM_date ==12)))
#Location
anova(lm(GI~ taxa +Location+replication, DH2020_2021%>% filter(DH2020_2021$Year=="2021",DH2020_2021$PM_date ==19)))
#Location
anova(lm(GI~ taxa +Location+replication, DH2020_2021%>% filter(DH2020_2021$Year=="2021",DH2020_2021$PM_date ==33)))
#Location significant
anova(lm(GI~ taxa +Location+replication, DH2020_2021%>% filter(DH2020_2021$Year=="2021",DH2020_2021$PM_date ==47)))
#neither significant
anova(lm(GI~ taxa +Location+replication, DH2020_2021%>% filter(DH2020_2021$Year=="2021",DH2020_2021$PM_date ==68)))
#Location significant
anova(lm(GI~ taxa +Location+replication, DH2020_2021%>% filter(DH2020_2021$Year=="2021",DH2020_2021$PM_date ==96)))
#rep and location significant
anova(lm(GI~ taxa +Location+replication, DH2020_2021%>% filter(DH2020_2021$Year=="2021",DH2020_2021$PM_date ==152)))
#all significant
#DH 2021 GE

anova(lm(GE~ taxa +Location+replication, DH2020_2021%>% filter(DH2020_2021$Year=="2021",DH2020_2021$PM_date ==5)))
#Location
anova(lm(GE~ taxa +Location+replication, DH2020_2021%>% filter(DH2020_2021$Year=="2021",DH2020_2021$PM_date ==12)))
#Location

anova(lm(GE~ taxa +Location+replication, DH2020_2021%>% filter(DH2020_2021$Year=="2021",DH2020_2021$PM_date ==19)))
#neither
anova(lm(GE~ taxa +Location+replication, DH2020_2021%>% filter(DH2020_2021$Year=="2021",DH2020_2021$PM_date ==33)))
#rep slightly

anova(lm(GE~ taxa +Location+replication, DH2020_2021%>% filter(DH2020_2021$Year=="2021",DH2020_2021$PM_date ==47)))
#rep sign
anova(lm(GE~ taxa +Location+replication, DH2020_2021%>% filter(DH2020_2021$Year=="2021",DH2020_2021$PM_date ==68)))
#Location and rep
anova(lm(GE~ taxa +Location+replication, DH2020_2021%>% filter(DH2020_2021$Year=="2021",DH2020_2021$PM_date ==96)))
#location

anova(lm(GE~ taxa +Location+replication, DH2020_2021%>% filter(DH2020_2021$Year=="2021",DH2020_2021$PM_date ==152)))
anova(lm(GI~ taxa +Location+replication+spot_bloch,DH2020_2021%>% filter(DH2020_2021$Year=="2021",DH2020_2021$PM_date ==96)))


lm(GI~taxa + scald,DH2020_2021%>%filter(DH2020_2021$Year=="2021",DH2020_2021$PM_date ==12))

#2020 and 2021 together

table(DH2020_2021$PM_date,DH2020_2021$Year)
anova(lm(GI~ taxa +Year+Year %in% Location+replication+ws_percent+Maturity_date:Year, DH2020_2021%>% filter(DH2020_2021$PM_date ==5)))
#Year significant

#rep not significant
anova(lm(GI~ taxa +replication+Year+Maturity_date%in%Year+Maturity_date, DH2020_2021%>% filter(DH2020_2021$PM_date ==19)))
#Year and year in location significant
anova(lm(GI~ taxa +Year%in%Location+replication+Year, DH2020_2021%>% filter(DH2020_2021$PM_date ==47)))
#Location and year significant
anova(lm(GI~ taxa +Year%in%Location+replication+Year, DH2020_2021%>% filter(DH2020_2021$PM_date ==96)))
#replication, year significant
anova(lm(GI~ taxa +Location%in%Year+replication+Year, DH2020_2021%>% filter(DH2020_2021$PM_date ==152)))
#all significant

#GE for both years
anova(lm(GE~ taxa +Year+Year %in% Location+replication, DH2020_2021%>% filter(DH2020_2021$PM_date ==5)))
#Year significant, Year in locatiobn slightly
anova(lm(GE~ taxa +Year%in%Location+replication+Year, DH2020_2021%>% filter(DH2020_2021$PM_date ==19)))
#Year and year in location significant
anova(lm(GE~ taxa +Year%in%Location+replication+Year, DH2020_2021%>% filter(DH2020_2021$PM_date ==47)))
#Year significant, Year:Location slightly
anova(lm(GI~ taxa +Year%in%Location+replication+Year, DH2020_2021%>% filter(DH2020_2021$PM_date ==96)))
#replication, year significant, Location slightly
anova(lm(GI~ taxa +Location%in%Year+replication+Year, DH2020_2021%>% filter(DH2020_2021$PM_date ==152)))
#all significant
#We should include rep, location within Year, and Year as effects for models
```
## Histogram Visualization of GE and GI for specific
```{r}

DH2020_2021 %>% pivot_longer(cols = c(GE,GI), names_to = 'trait') %>% filter(trait =='GE') %>%
  ggplot(aes(x = value, fill = TP))+geom_density()+facet_nested(TP ~trait+Year, scales = 'free')+
 theme_bw()+guides(fill = "none")+
  DH2020_2021 %>% pivot_longer(cols = c(GE,GI), names_to = 'trait') %>% filter(trait =='GI') %>%
  ggplot(aes(x = value, fill = TP))+geom_density()+facet_nested(TP ~trait+Year, scales = 'free')+
  theme_bw()+ guides(fill = "none")
  plot_layout(ncol = 2)

#comments about the data table
#each entry is replicated 8 times to cover 4 TPs for each replication
#This means that phenotype data for each entry is replicated that many times
#This shouldn't be a problem if comparing phenotype data within a timepoint,
# but when comparing between ensure that total number of observations are correct

#other notes from the data with field
#scald seems to have a significant effect in the models, this could mean that either scald resistance/susceptibility
  #affects germination OR that the resis/sucespt loci is closely associated with AlaAT
#Need to look into the maturity date problem more  
#####
```
#functions for analysis
```{r}


# 
#BLUPH2 = function(trait.lm) {
  #ses<- se.ranef(trait.lm)$'taxa' #where 'm' is your model object from 'lmer' (replace 'genotypes' with whatever you call your individuals in the data)
#  v_BLUP<- ses^2
 # sigma2_g=VarCorr(trait.lm, comp="Variance")$'taxa'[1]
 # Reliability<- 1- v_BLUP/ (2*sigma2_g)  #where sigma2_g is the genetic variance estimated
 # H2<- round(mean(Reliability),3)
#  return(H2)
#}


BLUPH2_new = function(trait.lmer,d,AMat_geno) {

  ses<- se.ranef(trait.lmer)$'taxa' 
  #where 'm' is your model object from 'lmer' (replace 'genotypes' with whatever you call your individuals in the data)
  v_BLUP<- ses^2
  vcov
  vcov=as.data.frame(VarCorr(trait.lmer, comp="Variance"));sigmaG2<-vcov[vcov$grp=="taxa","vcov"];residualG2<-vcov[vcov$grp=="Residual","vcov"]
  


  r<-mean(table(d$taxa))


  H2=round(sigmaG2/(sigmaG2+residualG2/r),3)
  H2
  v_BLUP<- ses^2
  ses<- se.ranef(trait.lmer)$'taxa'
  
  Reliability<- 1- v_BLUP/ (2*sigmaG2)  #where sigma2_g is the genetic variance estimated
  Cullis_H2<- round(mean(Reliability),3)
  trait<-d$trait%>%unique()
  PM<-d$PM_date%>%unique()
  TP<-d$TP%>%unique()
  Year<-d$year%>%unique()


  d1<-as.data.frame(d)%>%filter(d$taxa%in%rownames(AMat_geno))

  trait.GBLUP<-kin.blup(data=d1,geno = "taxa",pheno = "value",fixed=c("Location","rep"),K=AMat_geno,PEV=TRUE)
  
  ah2<-trait.GBLUP$Vg/(trait.GBLUP$Vg+trait.GBLUP$Ve)

  
  H2_both<-data.frame(trait.GBLUP$Vg,ah2,Cullis_H2,H2,trait,PM,TP,Year)
  H2_both
  
  return(H2_both)
}



BlueBlupsH2_Location_rep_taxa <- function(d, groupvars) {
#d<-d6%>%filter(year=="2020",trait=="GE",PM_date=="19",TP=="TP2")

    trait.lmer <- lmer(formula = value ~(1|taxa)+Location+rep, 
                       data = d)
    #in the future we should add maturity date and possibly scald here
      lineEf = (ranef(trait.lmer)$taxa + fixef(trait.lmer)[1])%>% as.data.frame() %>%rownames_to_column('taxa') %>% 
    dplyr::mutate(type = 'BLUP') %>% dplyr::rename(value = '(Intercept)')
      
    trait.lm = broom::tidy(lm(value~ taxa+Location+rep, data=d))
    #in the future we should add maturity date and possibly scald here
    first_taxa = d %>% arrange(taxa) %>% slice_head( n = 1) %>% dplyr::select(taxa) %>% as.character()
    Intercept = trait.lm %>% filter(term == '(Intercept)') %>% dplyr::select(estimate) %>% as.numeric()
    lineBLUE = trait.lm %>% filter(substr(term,1,4)=='taxa') %>% 
      add_row(term = paste0('taxa',first_taxa),
              estimate = 0) %>% mutate(BLUE = estimate + Intercept) %>%
      transmute(taxa = gsub(pattern = 'taxa',replacement = '',x = term),
                value = BLUE, type = 'BLUE')
    H2 = BLUPH2_new(trait.lmer,d,wmbGAPIT$A)

   
   df4= lineBLUE %>% arrange(type, taxa) %>%
      plyr::join(d %>% dplyr::select(taxa,trait,PM_date,TP,year) %>% unique())

    #H2_new=BLUPH2_new(trait.lmer,d=d2, wmbGAPIT$A)
    dfList=list(df4, H2)
    dfList
    return(dfList)
    
    
    
    
    
    
  }
  
#d6 = DH2020_2021 %>%dplyr::select(taxa, rep, Location, TP, GE,GI,PM_date,year,Family) %>% 
 #   mutate(year = factor(year, levels = c('2021','2020'))) %>%
 #   pivot_longer(cols = c(GE, GI), names_to = 'trait')# %>% filter(TP == 'TP2', trait == 'GE')

BlueBlupsH2_Year_rep_taxa <- function(d2, groupvars) {
  
  #d2<-DHCombined %>% filter(TP == 'TP2', trait == 'GE')
  length(unique(d2$year))
    if (length(unique(d2$year))==2) {
      trait.lmer <- lmer(formula = value ~(1|taxa)+Location + rep+year, data = d2)
      # fixef(trait.lmer)[2]/need to think about this more. 
      
      Cept = (fixef(trait.lmer)[1]*4+sum(fixef(trait.lmer)[2:4]))/4
      lineEf = (ranef(trait.lmer)$taxa + Cept) %>% as.data.frame() %>% rownames_to_column('taxa') %>% 
        mutate(type = 'BLUP') %>% dplyr::rename(value = '(Intercept)')
      
      trait.lm = broom::tidy(lm(value~ taxa+Location+ rep+year, data=d2))
      first_taxa = d2 %>% arrange(taxa) %>% slice_head( n = 1) %>% dplyr::select(taxa) %>% as.character()
      Intercept_list = trait.lm %>% filter(term == '(Intercept)'|substr(term,1,8)=='Location')
      Intercept = (Intercept_list$estimate[1]*4+sum(Intercept_list$estimate[2:4]))/4
      
      lineBLUE = trait.lm %>% filter(substr(term,1,4)=='taxa') %>% 
        add_row(term = paste0('taxa',first_taxa),
                estimate = 0) %>% mutate(BLUE = estimate + Intercept) %>%
        transmute(taxa = gsub(pattern = 'taxa',replacement = '',x = term),
                  value = BLUE, type = 'BLUE')
      H2 = BLUPH2_new(trait.lmer,d=d2,wmbGAPIT$A)
      
      df4<-rbind(lineEf, lineBLUE) %>% arrange(type, taxa) %>%
        plyr::join(d2 %>% dplyr::select(taxa,trait,PM_date,TP) %>% unique())
      list5<-list(df4,H2)
      return(list5)
    }
    else {
    # #  tt<-DH2020_2021%>%filter(year=="2020") %>% dplyr::select(taxa, rep, Location,TP,phs, GE, GI, PM_date,year,Family) %>% 
    #     pivot_longer(cols = c(GE, GI), names_to = 'trait') #%>%
    #     group_by(TP, PM_date, trait, year)
    #     table(tt$trait)
    #     tt<-tt%>%filter(TP=="TP2",PM_date=="19",trait=="GE",year=="2020")
      #group_by(TP, PM_date, trait, year
     # d2<-tt
      trait.lmer <- lmer(formula = value ~(1|taxa)+Location+rep, 
                         data = d2)
      lineEf = (ranef(trait.lmer)$taxa + fixef(trait.lmer)[1]) %>% as.data.frame() %>% rownames_to_column('taxa') %>% 
        mutate(type = 'BLUP') %>% dplyr::rename(value = '(Intercept)')
      lineEf
      trait.lm = broom::tidy(lm(value~ taxa+Location+rep, data=d2))
      trait.lm 
      first_taxa = d2 %>% arrange(taxa) %>% slice_head( n = 1) %>% dplyr::select(taxa) %>% as.character()
      Intercept = trait.lm %>% filter(term == '(Intercept)') %>% dplyr::select(estimate) %>% as.numeric()
      Intercept
      lineBLUE = trait.lm %>% filter(substr(term,1,4)=='taxa') %>% 
        add_row(term = paste0('taxa',first_taxa),
                estimate = 0) %>% mutate(BLUE = estimate + Intercept) %>%
        transmute(taxa = gsub(pattern = 'taxa',replacement = '',x = term),
                  value = BLUE,type = 'BLUE')
      lineBLUE 
      H2 = BLUPH2_new(trait.lmer,d=d2,wmbGAPIT$A)

     df4<-rbind(lineEf, lineBLUE) %>% arrange(type, taxa) %>%
               plyr::join(d2 %>% dplyr::select(taxa, trait,PM_date,TP,year) %>% unique())
list5<-list(df4,H2)
      return(list5)
    }
  }
```
## setting up
```{r}
DH2020_2021

#dplyr::rename(rep=replication,year=Year

DH2020_2021=DH2020_2021%>%mutate(PM_date=as.numeric(as.character((PM_date))))%>%filter(!Location=="Spring")%>%dplyr::rename(year=Year,rep=replication)
names(DH2020_2021)
phs<-DH2020_2021%>%dplyr::select(taxa,year,Location,SourcePLOT,phs)%>%unique
table(phs$yea,phs$Location)

480*2
DH2020_2021%>%group_by(year,TP)%>%dplyr::summarize(correlate(GI, phs,use="pairwise.complete.obs"))
DH2020_2021%>%group_by(year,TP)%>%as.matrix() 

###

library(arm)
library(rrBLUP)
library(tid)
load("data/Phenotype_Data/DH2020Estimates.Rdata")

DH2020Estimates = DH2020_2021%>%filter(year=="2020") %>% dplyr::select(taxa, rep, Location,TP,phs, GE, GI,PM_date,year,Family) %>% 
    pivot_longer(cols = c(GE, GI), names_to = 'trait') %>%
    group_by(TP, PM_date, trait, year) %>% group_map(BlueBlupsH2_Location_rep_taxa,.keep=TRUE)#%>% ungroup()%>%mutate(Family=ifelse(taxa=="Charles","Charles/Endeavor",Family))
#saved at bottom
save(DH2020Estimates,file="data/Phenotype_Data/DH2020Estimates.Rdata")
load("data/Phenotype_Data/DH2020Estimates.Rdata")
DH2020Estimates

DH2020_1<-DH2020Estimates[[1]][[1]]

#env_n<-length(table(BSR.df$Env))
for(i in 2:length(lengths(DH2020Estimates))-1){
  
  app<-DH2020Estimates[[c(i+1)]][[1]]
  DH2020_1<- rbind(DH2020_1,app)
}
DH2020_1=DH2020_1%>%arrange(year,trait,PM_date)
table(DH2020_1$PM_date,DH2020_1$trait)
#H2
DH2020_H2<-DH2020Estimates[[1]][[2]]
DH2020_H2
lengths(DH2020Estimates)
#env_n<-length(table(BSR.df$Env))
for(i in 2:length(lengths(DH2020Estimates))-1){
  
  app<-DH2020Estimates[[c(1+i)]][[2]]

  DH2020_H2<- rbind(DH2020_H2,app)
}
DH2020_H2=DH2020_H2%>%arrange(trait,PM)




```
## DH 2021
```{r}
##takes time
tt<- DH2020_2021%>%filter(year=="2020")

DH2021Estimates = DH2020_2021%>%filter(year=="2021") %>%droplevels()%>% dplyr::select(taxa, rep, Location,TP,phs, GE, GI,PM_date,year,Family) %>% 
    pivot_longer(cols = c(GE, GI), names_to = 'trait') %>%
    group_by(TP, PM_date, trait, year) %>% group_map(BlueBlupsH2_Location_rep_taxa,.keep=TRUE) #%>% ungroup()%>%mutate(Family=ifelse(taxa=="Endeavor","Charles/Endeavor",Family))



save(DH2021Estimates,file="data/Phenotype_Data/DH2021Estimates.Rdata")
load("data/Phenotype_Data/DH2021Estimates.Rdata")
lengths(DH2021Estimates)
table(DH2021Estimates$trait,DH2021Estimates$PM_date)

DH2021_1<-DH2021Estimates[[1]][[1]]
dim(DH2020_1)
DH2021Estimates[[1]][[1]]
DH2021Estimates[[1]][[1]]
length(lengths(DH2021Estimates))
DH2021_1
for(i in 2:length(lengths(DH2021Estimates))-1){
  
  app<-DH2021Estimates[[c(i+1)]][[1]]
  DH2021_1<- rbind(DH2021_1,app)
}
DH2021_1
DH2021_1=DH2021_1%>%arrange(year,trait,PM_date)


table(DH2021_1$PM_date,DH2021_1$trait)
#H2
DH2021_H2<-DH2021Estimates[[1]][[2]]
DH2021_H2
#env_n<-length(table(BSR.df$Env))
for(i in 1:length(lengths(DH2021Estimates))-1){
  
  app<-DH2021Estimates[[c(1+i)]][[2]]
  
  DH2021_H2<- rbind(DH2021_H2,app)
}
DH2021_H2=DH2021_H2%>%arrange(trait,PM)%>%unique()

DH2021_H2


#Both
DHCombined = DH2020_2021%>%filter(year=="2020")%>% dplyr::select(taxa, rep, Location,TP,phs, GE, GI,PM_date,year,Family) %>%mutate(Family=ifelse(taxa=="Charles","Charles/Endeavor",Family))%>%
  rbind(., DH2020_2021%>%filter(year=="2021") %>% dplyr::select(taxa, rep, Location, TP,phs, GE,GI,PM_date,year,Family) %>%mutate(Family=ifelse(taxa=="Endeavor","Charles/Endeavor",Family))) %>% 
  mutate(year = factor(year, levels = c('2021','2020'))) %>%  pivot_longer(cols = c(GE, GI), names_to = 'trait') %>%
  group_by(TP,PM_date, trait) %>%group_map(BlueBlupsH2_Year_rep_taxa,.keep=TRUE)  #%>% mutate(year = '2020/2021')
str(DHCombined)
save(DHCombined,file="data/Phenotype_Data/DHCombined.Rdata")
load("data/Phenotype_Data/DHCombined.Rdata")
DHcomb_1<-DHCombined[[1]][[1]]
DHcomb_1$year<-"2020/2021"
#env_n<-length(table(BSR.df$Env))
for(i in 1:length(lengths(DHCombined))-1){
  
  app<-DHCombined[[c(i+1)]][[1]]
  app$year<-"2020/2021"
  DHcomb_1<- rbind(DHcomb_1,app)
}
DHcomb_1=DHcomb_1%>%arrange(year,trait,PM_date)%>%unique()
DHcomb_1

#H2
DHComb_H2<-DHCombined[[1]][[2]]
DHComb_H2$Year<-"2020/2021"
#env_n<-length(table(BSR.df$Env))
for(i in 1:length(lengths(DHCombined))-1){
  
  app<-DHCombined[[c(1+i)]][[2]]
  app$Year<-"2020/2021"
  DHComb_H2<- rbind(DHComb_H2,app)
}
DHComb_H2=DHComb_H2%>%arrange(trait,PM)%>%unique()%>%mutate(Year = if_else(stringr::str_detect(TP, "\\."), "2021", Year))


```

#correlations
```{r}
DH2020_1%>% plyr::join(DH2021_1 %>% dplyr::select(!year)%>% dplyr::rename(value2021 = value))  %>%
  filter(!is.na(value2021), type =='BLUE')  %>% group_by(type, TP, trait) %>%
  summarise(correlation = cor(value, value2021))
```
# combine all results and change some naming
```{r}
#
#H@
DH_H2=rbind(DH2021_H2,DH2020_H2,DHComb_H2)
#data frames
AllDHBluesPerYear = rbind(DH2020_1,DH2021_1,DHcomb_1) %>% filter(type =='BLUE') %>% ungroup()%>%filter(!taxa%in%c("Endeavor","Charles"))%>%
  mutate(taxa=toupper(taxa))
AllDHBluesPerYear
#AllDHBluesPerYear[AllDHBluesPerYear$taxa=="SY_TEPEE",]$taxa<-"TEPEE"
#AllDHBluesPerYear[AllDHBluesPerYear$taxa=="DH130910",]$taxa<-"LIGHTNING"
```
#SAVE THE COMBINED RESULTS HERE
```{r}
save(AllDHBluesPerYear,file = "data/Phenotype_Data/AllDHBluesPerYear_first_step.Rdata")
save(DH_H2,file = "data/Phenotype_Data/Heritability_first_step.Rdata")



```
#Pease see GWAS Script for GWAS portion