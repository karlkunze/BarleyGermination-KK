---
title: "Phenotype Plotting"
author: "Karl Kunze"
date: "2/7/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r}
library(readr); library(readxl)
library(ggplot2); library(ggpubr)
library(gridExtra); library(here)
library(reshape2)
#load(here("WMB DH 2020 all data for analysis.RData"))
#load(here("data/Winter_DH/WDH_BLUEs_2020.RData"))
load(here("data/Winter_DH/TP1_WDH20_BLUE_all.RData"))#TP1_WDH20_BLUE_all
load(here("data/Winter_DH/TP2_WDH20_BLUE_all.RData"))
load(here("data/Winter_DH/TP3_WDH20_BLUE_all.RData"))
load(here("data/Winter_DH/TP4_WDH20_BLUE_all.RData"))
load(here("data/Winter_DH/TP5_WDH20_BLUE_all.RData"))
load(here("data/Winter_DH/WMB DH 2020 all data for analysis.RData"))#All_pheno_TPall

TP_all_WDH20_BLUE_all<-rbind(TP1_WDH20_BLUE_all,TP2_WDH20_BLUE_all,TP3_WDH20_BLUE_all,TP4_WDH20_BLUE_all,TP5_WDH20_BLUE_all)

TP_all_WDH20_BLUE_all[TP_all_WDH20_BLUE_all$taxa=="Flavia",]$taxa="Check 1-Flavia"

TP_all_WDH20_BLUE_all[TP_all_WDH20_BLUE_all$taxa=="Scala",]$taxa="Check 2-Scala"
TP_all_WDH20_BLUE_all[TP_all_WDH20_BLUE_all$taxa=="DH130910",]$taxa="Check 3-DH130910"
TP_all_WDH20_BLUE_all[TP_all_WDH20_BLUE_all$taxa=="SY Tepee",]$taxa="Check 4-SY Tepee"
TP_all_WDH20_BLUE_all[TP_all_WDH20_BLUE_all$taxa=="Wintmalt",]$taxa="Check 5-Wintmalt"
TP_all_WDH20_BLUE_all[TP_all_WDH20_BLUE_all$taxa=="Charles",]$taxa="Check 6-Charles"

table(All_pheno_TPall[is.na(All_pheno_TPall$Pedigree),]$Entry)



TP_all_WDH20_BLUE_all$Pedigree
table(TP_all_WDH20_BLUE_all$taxa)
table(All_pheno_TPall$Entry)
View(All_pheno_TPall$Family[match(TP_all_WDH20_BLUE_all$taxa,All_pheno_TPall$Entry)])

TP_all_WDH20_BLUE_all$Pedigree=All_pheno_TPall$Family[match(TP_all_WDH20_BLUE_all$taxa,All_pheno_TPall$Entry)]

TP_all_WDH20_BLUE_all$Check=All_pheno_TPall$Check[match(TP_all_WDH20_BLUE_all$taxa,All_pheno_TPall$Entry)]


# All_pheno_TPall$Entry
# TP1_WDH20_BLUE_all$Pedigree<-All_pheno_TPall$Family[match(TP1_WDH20_BLUE_all$taxa,All_pheno_TPall$Entry)]
# TP2_WDH20_BLUE_all$Pedigree<-All_pheno_TPall$Family[match(TP2_WDH20_BLUE_all$taxa,All_pheno_TPall$Entry)]
# 
# TP3_WDH20_BLUE_all$Pedigree<-All_pheno_TPall$Family[match(TP3_WDH20_BLUE_all$taxa,All_pheno_TPall$Entry)]
# TP4_WDH20_BLUE_all$Pedigree<-All_pheno_TPall$Family[match(TP4_WDH20_BLUE_all$taxa,All_pheno_TPall$Entry)]
# 
# TP5_WDH20_BLUE_all$Pedigree<-All_pheno_TPall$Family[match(TP5_WDH20_BLUE_all$taxa,All_pheno_TPall$Entry)]
# 
# TP_WDH20_BLUE_all.F<-rbind(TP1_WDH20_BLUE_all,TP2_WDH20_BLUE_all,TP3_WDH20_BLUE_all,TP4_WDH20_BLUE_all,TP5_WDH20_BLUE_all)
table(TP_WDH20_BLUE_all$Pedigree)
```
box plots
```{r}
TP_all_melt=melt(TP_all_WDH20_BLUE_all, id.vars =c("taxa","TP","Pedigree","Check"), measure.vars = c("GE"))

#wdh1melt=rbind(melt(Cwdh, id.vars =c("Entry","Timepoint"), measure.vars = c("GE")),
              # melt(Cwdh, id.vars =c("Entry","Timepoint"), measure.vars = #c("GIscale")))
#wdh1melt=wdh1melt[-c(which(is.na(wdh1melt$TP))),]

#wdh2melt$dataset="wdh2"; wdh1melt$dataset="wdh1"; 
#wdhmelt=rbind(wdh2melt, wdh1melt)
# levels(wdhmelt$variable)= c("Germination energy", "Germination index")

TP_WDH20_BLUE_all[is.na(TP_WDH20_BLUE_all$Pedigree),]


TP_all_melt_GE=melt(TP_all_WDH20_BLUE_all, id.vars =c("taxa","TP","Pedigree","Check"), measure.vars = c("GE"))
TP_all_melt_GE$TP=sapply(str_split(TP_all_melt_GE$TP,"P",2),`[`,2)
 
#TP_all_melt_GE=TP_all_melt_GE[!TP_all_melt_GE$TP=="5",]

SubGE<-function(c){

df=TP_all_melt_GE[TP_all_melt_GE$Check=="C"| TP_all_melt_GE$Pedigree==c,]
df$Family=df$Pedigree
df[df$Check=="C" &df$Pedigree==c,]$Family=paste0(c," Check")
df[df$Check=="B",]$Family="Experimental Lines"
df
}
Flavia=SubGE("Flavia")
Flavia$Family
Scala=SubGE("Scala")
SY_Tepee=SubGE("SY Tepee")
Wintmalt=SubGE("Wintmalt")

#Germination Energy Line Scale
library(gridExtra)
get_legend<-function(myggplot){
  tmp <- ggplot_gtable(ggplot_build(myggplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
}




q1.T<-ggplot(data=Flavia, aes(x=TP, y=value,group=taxa,linetype=Check,color=Family)) +
    ggtitle(paste0("Germination Energy ",as.character(substitute(Flavia))))+
    
  scale_color_manual(values=c("#ee0000","#4c7c82","gray","magenta","orange","#87ceeb","#102969"))+

    
  scale_fill_manual()+
  
  geom_line(size=0.8) +
  theme_bw()+
  
  theme(plot.title = element_text(hjust = 0.5),axis.title.x=element_blank(),axis.title.y=element_blank())
legend=get_legend(q1.T)

q1<-ggplot(data=Flavia, aes(x=TP, y=value,group=taxa,linetype=Check,color=Family)) +
    ggtitle(paste0("GE Flavia"))+
    
  scale_color_manual(values=c("#ee0000","#4c7c82","gray","magenta","orange","#87ceeb","#102969"))+

    
  scale_fill_manual()+
  
  geom_line(size=0.8) +
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.5),legend.position = "none",axis.title.x=element_blank(),axis.title.y=element_blank())
q1

q2<-ggplot(data=Scala, aes(x=TP, y=value,group=taxa,linetype=Check,color=Family)) +
    ggtitle(paste0("GE Scala"))+
    
  scale_color_manual(values=c("#ee0000","#4c7c82","gray","magenta","orange","#87ceeb","#102969"))+

    
  scale_fill_manual()+
  
  geom_line(size=0.8) +
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.5),legend.position = "none",axis.title.x=element_blank(),axis.title.y=element_blank())
q2

q3<-ggplot(data=SY_Tepee, aes(x=TP, y=value,group=taxa,linetype=Check,color=Family)) +
    ggtitle(paste0("GE SY Tepee"))+
    
  scale_color_manual(values=c("#ee0000","#4c7c82","gray","magenta","orange","#87ceeb","#102969"))+

    
  scale_fill_manual()+
  
  geom_line(size=0.8) +
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.5),legend.position = "none",axis.title.x=element_blank(),axis.title.y=element_blank())
q3
q4<-ggplot(data=Wintmalt, aes(x=TP, y=value,group=taxa,linetype=Check,color=Family)) +
    ggtitle(paste0("GE Wintmalt"))+
    
  scale_color_manual(values=c("#ee0000","#4c7c82","gray","magenta","orange","#87ceeb","#102969"))+

    
  scale_fill_manual()+
  
  geom_line(size=0.8) +
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.5),legend.position = "none",axis.title.x=element_blank(),axis.title.y=element_blank())
q4

blankPlot <- ggplot()+geom_blank(aes(1,1)) + 
  cowplot::theme_nothing()
q4
# 4. Arrange ggplot2 graphs with a specific width
grid.arrange(q1,q2,legend,q3,q4,blankPlot,ncol=3,nrow=2)

figure<-grid.arrange(q1, q2 ,q3, q4, 
             layout_matrix=rbind(c(1,1,2,2), c(3,3,4,4)))

anno<-annotate_figure(figure,
                top = text_grob("3 Day Germination BLUES", face = "bold", size = 14),
                bottom = text_grob("Time Point", size = 12))
anno
grid.arrange(legend)
ggplot(data=Flavia, aes(x=TP, y=value,color=Color)) +
  geom_boxplot()+
  #facet_grid(cols=vars(dataset), scales="free", rows=vars(variable)) +
  theme_bw() + 
  ggtitle("Fixed Effect GE distributions")+
  scale_fill_manual(values=c("#cccccc", "#636363")) +
 
  xlab("Time point") + ylab("BLUE GE") 
 
#GI
TP_all_melt_GI=melt(TP_all_WDH20_BLUE_all, id.vars =c("taxa","TP","Pedigree","Check"), measure.vars = c("GIscale"))
ggplot(data=TP_all_melt_GI, aes(x=TP, y=value,color=Pedigree)) +
  geom_boxplot()+
  #facet_grid(cols=vars(dataset), scales="free", rows=vars(variable)) +
  theme_bw() + 
  ggtitle("Fixed Effect GI Scale distributions")+
  scale_fill_manual(values=c("#cccccc", "#636363")) +
  theme(legend.position = "none")+
  xlab("Time point") + ylab("BLUE GI Scale") 
#5 Day
TP_all_melt_GE_5D=melt(TP_WDH20_BLUE_all, id.vars =c("taxa","TP","Pedigree"), measure.vars = c("GE_5D"))
ggplot(data=TP_all_melt_GE_5D, aes(x=TP, y=value,color=Pedigree)) +
  geom_boxplot()+
  #facet_grid(cols=vars(dataset), scales="free", rows=vars(variable)) +
  theme_bw() + 
  ggtitle("Fixed Effect 5 Day GE distributions")+
  scale_fill_manual(values=c("#cccccc", "#636363")) +
  theme(legend.position = "none")+
  xlab("Time point") + ylab("BLUE GE") 

TP_all_melt_GI_5D=melt(TP_WDH20_BLUE_all, id.vars =c("taxa","TP","Pedigree"), measure.vars = c("GIScale_5D"))
ggplot(data=TP_all_melt_GI_5D, aes(x=TP, y=value,color=Pedigree)) +
  geom_boxplot()+
  #facet_grid(cols=vars(dataset), scales="free", rows=vars(variable)) +
  theme_bw() + 
  ggtitle("Fixed Effect 5 Day GI Scale distributions")+
  scale_fill_manual(values=c("#cccccc", "#636363")) +
  #theme(legend.position = "none")+
  xlab("Time point") + ylab("BLUE GI Scale") 




# 5 Day
```
```{r}
Cwdh$GIscale_5

wdh2melt5=melt(Cwdh, id.vars =c("Entry","Timepoint","Pedigree"), measure.vars = c("GE_5D", "GIscale_5D"))
wdh1melt5=rbind(melt(Cwdh, id.vars =c("Entry","Timepoint","Pedigree"), measure.vars = c("GE_5D")),
               melt(Cwdh, id.vars =c("Entry","Timepoint","Pedigree"), measure.vars = c("GIscale_5D")))
wdh1melt5=wdh1melt5[-c(which(is.na(wdh1melt5$Timepoint))),]
str(wdh1melt5)
wdh2melt5$dataset="wdh2_5D"; wdh1melt5$dataset="wdh1_5D"; 
wdhmelt5=rbind(wdh2melt5, wdh1melt5)

 levels(wdhmelt5$variable)= c("Germination energy 5D", "Germination index 5D")

str(wdh1melt5$Pedigree)
ggplot(data=wdh1melt5, aes(x=Timepoint, y=value, fill=dataset)) +
  geom_boxplot(aes(fill=Timepoint))+
  facet_grid(cols=vars(dataset), scales="free", rows=vars(variable)) +
  theme_bw() + 
  
  #ggtitle("Raw GE distributions")+
  
  theme(legend.position = "none")+
  xlab("Time point") + ylab("") 



```

```{r}
Cwdh
WDHmelt_scale_GE=melt(Cwdh, id.vars =c("Entry","Pedigree","Timepoint", "Location"), measure.vars = c("GE"))


wdh2=aggregate(value~ Pedigree+Timepoint, data=WDHmelt_scale_GE, mean)

wdh2[!wdh2$Timepoint==5,]
ggplot(data=wdh2[!wdh2$Timepoint==5,], aes(x=Timepoint, y=value, group=Pedigree, color=Pedigree)) +
  
  scale_fill_manual(labels = paste(levels(wdh2$Pedigree), table(Cwdh$Pedigree)))+
  geom_point()+
  geom_line(size=1) +
  theme_bw() + 
  geom_hline(yintercept =0.98, color="red", linetype=3, size=1)+
  
  #scale_color_manual(values=c("#b2182b","#fddbc7","#d1e5f0", "#67a9cf", "#2166ac"), labels=c("DNN", "DDD","DDN","NDD", "NDN"), name="Haplotype") + 
  ylab("WDH germination index") + xlab("Time point")+ggtitle("GE over Timepoints")

WDHmelt_GE=melt(Cwdh, id.vars =c("Entry","Pedigree","Timepoint", "Location"), measure.vars = c("GE"))

table(wdh2$Pedigree)
wdh2=aggregate(value~ Pedigree+Timepoint, data=WDHmelt_GE, mean)
ggplot(data=wdh2, aes(x=Timepoint, y=value, group=Pedigree, color=Pedigree)) +
  geom_point()+
  geom_line(size=1) +
  theme_bw() + 
  
  #geom_hline(yintercept =5.5, color="red", linetype=3, size=1)+
  #scale_color_manual(values=c("#b2182b","#fddbc7","#d1e5f0", "#67a9cf", "#2166ac"), labels=c("DNN", "DDD","DDN","NDD", "NDN"), name="Haplotype") + 
  ylab("WDH germination Energy") + xlab("Time point")
WDHmelt_GE
ggplot(data=wdh2, aes(x=Timepoint, y=value, group=Pedigree, color=Pedigree)) +
  geom_point()+
  geom_line(size=1) +
  theme_bw() + 
  
  #geom_hline(yintercept =5.5, color="red", linetype=3, size=1)+
  #scale_color_manual(values=c("#b2182b","#fddbc7","#d1e5f0", "#67a9cf", "#2166ac"), labels=c("DNN", "DDD","DDN","NDD", "NDN"), name="Haplotype") + 
  ylab("WDH germination Energy") + xlab("Time point")
```

Graphs from GGS plotting
```{r}

#This is a line plot, I would like to expand to pedigree for the winter
BBBReg_allTP=merge(BBBReg_allTP, allGI[,c(1,11)], by="taxa")
BBBregmelt=melt(BBBReg_allTP, id.vars =c("taxa","haplo","TimePoint", "Location"), measure.vars = c("GIscale"))
BBBregmelt$haplo=factor(BBBregmelt$haplo, levels = c( "202", "220","222","020",  "022"))

bbbreg2=aggregate(value~ haplo +TimePoint, data=BBBregmelt, mean)
ggplot(data=bbbreg2, aes(x=TimePoint, y=value, group=haplo, color=haplo)) +
  geom_point()+
 
  geom_line(size=1.5) +
  theme_bw() + 
  geom_hline(yintercept =5.5, color="red", linetype=3, size=1)+
  scale_color_manual(values=c("#b2182b","#fddbc7","#d1e5f0", "#67a9cf", "#2166ac"), labels=c("DNN", "DDD","DDN","NDD", "NDN"), name="Haplotype") + 
  ylab("CU2 germination index") + xlab("Time point")

```



```



```{r}
library(melt)




wdhscale=melt(All_pheno_TPall, id.vars =c("Entry","Timepoint", "Location"), measure.vars = c("GI"))
wdhGE=melt(All_pheno_TPall, id.vars =c("Entry","Timepoint", "Location"), measure.vars = c("GE"))

str(All_pheno_TPallmelt)
wdh2=aggregate(value~ Timepoint+Entry, data=All_pheno_TPallmelt, mean)
str(wdh2)
ggplot(data=wdh2, aes(x=Timepoint, y=value)) +
  geom_point()+
  geom_line(size=1.5) +
  theme_bw() + 
  geom_hline(yintercept =5.5, color="red", linetype=3, size=1)+
  ylab("CU2 germination index") + xlab("Time point")


```